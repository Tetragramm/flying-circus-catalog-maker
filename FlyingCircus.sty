\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{FlyingCircus}

\RequirePackage[a4paper, left=0.75in, right=0.75in, top=0.25in, bottom=0.25in, headheight=38pt, includeheadfoot]{geometry}
\RequirePackage{graphicx}
\RequirePackage[normalem]{ulem}
\RequirePackage[T1]{fontenc}
\RequirePackage{nicematrix}
\RequirePackage{calc}
\RequirePackage{tikz}
\usetikzlibrary{calc}
\usetikzlibrary{positioning}
\usetikzlibrary{patterns,patterns.meta}
\RequirePackage{tikzpagenodes}
\RequirePackage[colaction]{multicol}
\RequirePackage{hyperref}
\RequirePackage{ragged2e}
\RequirePackage{fontspec}
\RequirePackage{nicefrac}
\RequirePackage{datatool}
\RequirePackage{fancyhdr}
\RequirePackage[auto]{contour}
\RequirePackage{newunicodechar}
\RequirePackage{xparse}
\RequirePackage{pgfkeys}
\RequirePackage[skins]{tcolorbox}
\RequirePackage[linktoc=page]{etoc}
\RequirePackage{pgf-pie}
\RequirePackage[skip=2pt plus1pt]{parskip}
\RequirePackage{kvoptions}
\RequirePackage[final]{pdfpages}
\RequirePackage{pdflscape}
\RequirePackage{mdframed}

\DeclareVoidOption{OrigBox}{\renewcommand{\UseDefaultBox}{Yes}}
\DeclareVoidOption{Wingdings}{\renewcommand{\SetPropSymbol}{
        % Import FlyingCircus.sty
        \newfontfamily\wingd{wingdings}
        %This is the propeller symbol
        \newunicodechar{✣}{{\wingd \symbol{"F0CB}}}}}

\newcommand{\UseDefaultBox}{}
\newcommand{\SetPropSymbol}{\newunicodechar{✣}{{\matdes \symbol{"F1A29}}}}
\ProcessKeyvalOptions*

% Set up the link styles, shouldn't need to modify
\hypersetup{
    pdfinfo={
            PageMode=UseOutlines,
            Creator=Tetragramm
        },
    final,
    hidelinks,
    linktoc=all,
    bookmarksdepth=4,
}

% Default paths for pictures
\graphicspath{{./images/}}

% Start in alpha page numbering
\pagenumbering{alph}

%%Load Fonts ==========================
%Load Normal Font
\setmainfont{Balthazar-Regular.ttf}[
    Path=./fonts/,
    AutoFakeSlant=0.2,
    AutoFakeBold=1.5,
    Ligatures={{TeX}},
]
%Load icon font for propeller symbol
\newfontfamily\matdes{materialdesignicons-webfont.ttf}[
    Path=./fonts/,
]
%This is the propeller symbol
\SetPropSymbol

%Load Flying Cirucs logo font
\newfontfamily\Kochfont{Koch-Fraktur.ttf}[
    Path=./fonts/,
    AutoFakeSlant=0.2,
    RawFeature=+shuffle,
]

% Definition of \fauxsc, used in \KeyWord to turn it into Small Caps
% Original by: Steven B. Segletes @ StackExchange
% Source: https://tex.stackexchange.com/a/225078
\makeatother
\newcommand\fauxsc[1]{\fauxschelper#1 \relax\relax}
\def\fauxschelper#1 #2\relax{%
    \fauxschelphelp#1\relax\relax%
    \if\relax#2\relax\else\ \fauxschelper#2\relax\fi%
}
\def\Hscale{.78}\def\Vscale{.83}\def\Cscale{1.00}
\def\fauxschelphelp#1#2\relax{%
    \ifnum`#1=\lccode`#1\relax\scalebox{\Hscale}[\Vscale]{\char\uccode`#1}\else%
    \scalebox{\Cscale}[1]{#1}\fi%
    \ifx\relax#2\relax\else\fauxschelphelp#2\relax\fi}

% Define colors =====================
\definecolor{DarkGray}{gray}{0.4}
\definecolor{MidGray}{gray}{0.5}

% Default text behavior ========================
\DTLsetseparator{=}
\tolerance=1
\emergencystretch=\maxdimen
\hyphenpenalty=10000
\hbadness=10000
\setlength{\parindent}{0pt}
\setlength{\RaggedRightParindent}{\parindent}


% Constants for the fancy outlined logo
\contourlength{2pt} %how thick each copy is

% Squish the itemize together a bit.  Less space
\let\olditemize=\itemize \let\endolditemize=\enditemize \renewenvironment{itemize}{\olditemize \itemsep0.1em}{\endolditemize}
\multicolsep = 0pt

%% Fancy header and footer=================================
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrule}{}
\renewcommand{\footrule}{}

\makeatletter
\def\@seccntformat#1{%
    \expandafter\ifx\csname c@#1\endcsname\c@section\else
        \csname the#1\endcsname\quad
    \fi}
\makeatother

\fancyhead[CE]{
    \begin{tikzpicture}
        \node [draw, circle, fill=black, minimum size=3mm] (l) at (-0.4\paperwidth,0) {};
        \node [draw, circle, fill=black, minimum size=3mm] (r) at (0.4\paperwidth,0) {};
        \draw [line width=0.75mm] (-0.4\paperwidth,0) -- (0.4\paperwidth,0);
        \foreach \x in {
                -0.38, -0.37, -0.36, -0.35, -0.34, -0.33, -0.32, -0.31, -0.3, -0.29, -0.28, -0.27, -0.26, -0.25, -0.24, -0.23, -0.22, -0.21, -0.2, -0.19, -0.18, -0.17, -0.16, -0.15, -0.14, -0.13, -0.12, -0.11, -0.1, -0.09, -0.08, -0.07, -0.06, -0.05, -0.04, -0.03, -0.02, -0.01, 0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1, 0.11, 0.12, 0.13, 0.14, 0.15, 0.16, 0.17, 0.18, 0.19, 0.2, 0.21, 0.22, 0.23, 0.24, 0.25, 0.26, 0.27, 0.28, 0.29, 0.3, 0.31, 0.32, 0.33, 0.34, 0.35, 0.36, 0.37, 0.38
            }
        \draw [line width=0.75mm] (\x\paperwidth-0.01\paperwidth,0.01\paperwidth) -- (\x\paperwidth+0.01\paperwidth,-0.01\paperwidth);
        \node (text) at (0,-0.003\paperwidth) {
            \contour{white}{\Kochfont\Large Flying Circus}
        };
    \end{tikzpicture}
}
\fancyhead[CO]{
    \begin{tikzpicture}
        \node [draw, circle, fill=black, minimum size=3mm] (l) at (-0.4\paperwidth,0) {};
        \node [draw, circle, fill=black, minimum size=3mm] (r) at (0.4\paperwidth,0) {};
        \draw [line width=0.75mm] (-0.4\paperwidth,0) -- (0.4\paperwidth,0);
        \foreach \x in {
                -0.38, -0.37, -0.36, -0.35, -0.34, -0.33, -0.32, -0.31, -0.3, -0.29, -0.28, -0.27, -0.26, -0.25, -0.24, -0.23, -0.22, -0.21, -0.2, -0.19, -0.18, -0.17, -0.16, -0.15, -0.14, -0.13, -0.12, -0.11, -0.1, -0.09, -0.08, -0.07, -0.06, -0.05, -0.04, -0.03, -0.02, -0.01, 0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1, 0.11, 0.12, 0.13, 0.14, 0.15, 0.16, 0.17, 0.18, 0.19, 0.2, 0.21, 0.22, 0.23, 0.24, 0.25, 0.26, 0.27, 0.28, 0.29, 0.3, 0.31, 0.32, 0.33, 0.34, 0.35, 0.36, 0.37, 0.38
            }
        \draw [line width=0.75mm] (\x\paperwidth+0.01\paperwidth,0.01\paperwidth) -- (\x\paperwidth-0.01\paperwidth,-0.01\paperwidth);
        \node (text) at (0,-0.003\paperwidth) {
            \contour{white}{\Kochfont\Large Flying Circus}
        };
    \end{tikzpicture}
}
\fancyfoot[LO]{
    {\Kochfont\Large\thepage} \hfill
    \begin{tikzpicture}
        \node [draw, circle, fill=black, minimum size=3mm] (l) at (-0.35\paperwidth,0) {};
        \node [draw, circle, fill=black, minimum size=3mm] (r) at (0.4\paperwidth,0) {};
        \draw [line width=0.75mm] (-0.35\paperwidth,0) -- (0.4\paperwidth,0);
        \foreach \x in {
                -0.33, -0.32, -0.31, -0.30, -0.29, -0.28, -0.27, -0.26, -0.25, -0.24, -0.23, -0.22, -0.21, -0.2, -0.19, -0.18, -0.17, -0.16, -0.15, -0.14, -0.13, -0.12, -0.11, -0.1, -0.09, -0.08, -0.07, -0.06, -0.05, -0.04, -0.03, -0.02, -0.01, 0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1, 0.11, 0.12, 0.13, 0.14, 0.15, 0.16, 0.17, 0.18, 0.19, 0.2, 0.21, 0.22, 0.23, 0.24, 0.25, 0.26, 0.27, 0.28, 0.29, 0.3, 0.31, 0.32, 0.33, 0.34, 0.35, 0.36, 0.37, 0.38
            }
        \draw [line width=0.75mm] (\x\paperwidth+0.01\paperwidth,0.01\paperwidth) -- (\x\paperwidth-0.01\paperwidth,-0.01\paperwidth);
    \end{tikzpicture}
}
\fancyfoot[RE]{
    \begin{tikzpicture}
        \node [draw, circle, fill=black, minimum size=3mm] (l) at (-0.35\paperwidth,0) {};
        \node [draw, circle, fill=black, minimum size=3mm] (r) at (0.4\paperwidth,0) {};
        \draw [line width=0.75mm] (-0.35\paperwidth,0) -- (0.4\paperwidth,0);
        \foreach \x in {
                -0.33, -0.32, -0.31, -0.30, -0.29, -0.28, -0.27, -0.26, -0.25, -0.24, -0.23, -0.22, -0.21, -0.2, -0.19, -0.18, -0.17, -0.16, -0.15, -0.14, -0.13, -0.12, -0.11, -0.1, -0.09, -0.08, -0.07, -0.06, -0.05, -0.04, -0.03, -0.02, -0.01, 0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1, 0.11, 0.12, 0.13, 0.14, 0.15, 0.16, 0.17, 0.18, 0.19, 0.2, 0.21, 0.22, 0.23, 0.24, 0.25, 0.26, 0.27, 0.28, 0.29, 0.3, 0.31, 0.32, 0.33, 0.34, 0.35, 0.36, 0.37, 0.38
            }
        \draw [line width=0.75mm] (\x\paperwidth-0.01\paperwidth,0.01\paperwidth) -- (\x\paperwidth+0.01\paperwidth,-0.01\paperwidth);
    \end{tikzpicture}
    \hfill {\Kochfont\Large\thepage}
}

\fancypagestyle{FancyTOC}{%
    \fancyhf{}
    \renewcommand{\headrule}{}
    \renewcommand{\footrule}{}
    \fancyhead[C]{%The Left style header is on Odd pages
        \begin{tikzpicture}[remember picture, overlay]
            \node [draw, circle, fill=black, minimum size=3mm] (l) at (-0.4\paperwidth,0) {};
            \node [draw, circle, fill=black, minimum size=3mm] (r) at (0.4\paperwidth,0) {};
            \draw [line width=0.75mm] (-0.4\paperwidth,0) -- (0.4\paperwidth,0);
            \foreach \x in {
                    -0.38, -0.37, -0.36, -0.35, -0.34, -0.33, -0.32, -0.31, -0.3, -0.29, -0.28, -0.27, -0.26, -0.25, -0.24, -0.23, -0.22, -0.21, -0.2, -0.19, -0.18, -0.17, -0.16, -0.15, -0.14, -0.13, -0.12, -0.11, -0.1, -0.09, -0.08, -0.07, -0.06, -0.05, -0.04, -0.03, -0.02, -0.01, 0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1, 0.11, 0.12, 0.13, 0.14, 0.15, 0.16, 0.17, 0.18, 0.19, 0.2, 0.21, 0.22, 0.23, 0.24, 0.25, 0.26, 0.27, 0.28, 0.29, 0.3, 0.31, 0.32, 0.33, 0.34, 0.35, 0.36, 0.37, 0.38
                }
            \draw [line width=0.75mm] (\x\paperwidth-0.01\paperwidth,0.01\paperwidth) -- (\x\paperwidth+0.01\paperwidth,-0.01\paperwidth);
        \end{tikzpicture}
    }
    \fancyfoot[C]{%The Left style footer is on Odd pages
        \begin{tikzpicture}
            \node [draw, circle, fill=black, minimum size=3mm] (l) at (-0.2\paperwidth,0) {};
            \node [draw, circle, fill=black, minimum size=3mm] (r) at (0.2\paperwidth,0) {};
            \draw [line width=0.75mm] (-0.2\paperwidth,0) -- (0.2\paperwidth,0);
            \foreach \x in {
                    -0.19, -0.18, -0.17, -0.16, -0.15, -0.14, -0.13, -0.12, -0.11, -0.1, -0.09, -0.08, -0.07, -0.06, -0.05, -0.04, -0.03, -0.02, -0.01, 0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1, 0.11, 0.12, 0.13, 0.14, 0.15, 0.16, 0.17, 0.18, 0.19
                }
            \draw [line width=0.75mm] (\x\paperwidth-0.01\paperwidth,0.01\paperwidth) -- (\x\paperwidth+0.01\paperwidth,-0.01\paperwidth);
        \end{tikzpicture}
    }
}

\fancypagestyle{PlaybookStyle}{%
    \fancyhf{}
    \renewcommand{\headrule}{}
    \renewcommand{\footrule}{}
    \fancyhead[C]{%The Left style header is on Odd pages
        \begin{tikzpicture}[remember picture, overlay]
            \node [draw, circle, fill=black, minimum size=3mm] (l) at (-0.45\paperwidth,0) {};
            \node [draw, circle, fill=black, minimum size=3mm] (r) at (-0.45\paperwidth,-0.93\paperheight) {};
            \draw [line width=0.75mm] (-0.45\paperwidth,0) -- (-0.45\paperwidth,-0.93\paperheight);
            \draw [line width=0.5mm] (-0.45\paperwidth+0.007\paperwidth,0) -- (-0.45\paperwidth+0.007\paperwidth,-0.93\paperheight);
            \draw [line width=0.5mm] (-0.45\paperwidth-0.007\paperwidth,0) -- (-0.45\paperwidth-0.007\paperwidth,-0.93\paperheight);

            \node [draw, circle, fill=black, minimum size=6mm] at (0.45\paperwidth,-0.83\paperheight) {};
            \node [draw, circle, fill=black, minimum size=6mm] at (0.45\paperwidth,-0.1\paperheight) {};
            \draw [line width=0.5mm] (0.455\paperwidth,-0.83\paperheight) -- (0.455\paperwidth,-0.1\paperheight);
            \draw [line width=0.5mm] (0.445\paperwidth,-0.83\paperheight) -- (0.445\paperwidth,-0.1\paperheight);
            \foreach \x in {
                    -0.81, -0.80, -0.79, -0.78, -0.77, -0.76, -0.75, -0.74, -0.73, -0.72, -0.71, -0.7, -0.69, -0.68, -0.67, -0.66, -0.65, -0.64, -0.63, -0.62, -0.61, -0.6, -0.59, -0.58, -0.57, -0.56, -0.55, -0.54, -0.53, -0.52, -0.51, -0.5, -0.49, -0.48, -0.47, -0.46, -0.45, -0.44, -0.43, -0.42, -0.41, -0.4, -0.39, -0.38, -0.37, -0.36, -0.35, -0.34, -0.33, -0.32, -0.31, -0.3, -0.29, -0.28, -0.27, -0.26, -0.25, -0.24, -0.23, -0.22, -0.21, -0.2, -0.19, -0.18, -0.17, -0.16, -0.15, -0.14, -0.13, -0.12
                }
            \draw [line width=1mm] (0.45\paperwidth-0.01\paperheight, \x\paperheight+0.01\paperheight) -- (0.45\paperwidth+0.01\paperheight, \x\paperheight-0.01\paperheight);

            \draw [line width=0.75mm] (-0.45\paperwidth,-0.47\paperheight) -- (0.45\paperwidth,-0.47\paperheight);
            \draw [line width=0.25mm] (-0.45\paperwidth,+0.25mm) -- (\paperwidth,+0.25mm);
            \draw [line width=0.25mm] (-0.45\paperwidth,-0.25mm) -- (\paperwidth,-0.25mm);
            \draw [line width=0.25mm] (-0.45\paperwidth,-0.93\paperheight+0.25mm) -- (\paperwidth,-0.93\paperheight+0.25mm);
            \draw [line width=0.25mm] (-0.45\paperwidth,-0.93\paperheight-0.25mm) -- (\paperwidth,-0.93\paperheight-0.25mm);

            \node (text) at (-0.45\paperwidth+0.003\paperwidth,-0.465\paperheight) {
                \rotatebox{90}{\contour{white}{\Kochfont\Large Flying Circus}}
            };
            \node (text2) at (0.45\paperwidth+0.003\paperwidth, -0.465\paperheight) {
                \rotatebox{90}{\contour{white}{\Kochfont\Huge \rightmark}}
            };
        \end{tikzpicture}
    }
}

\newlength{\picvert}
% Testing image sizing
\newsavebox\mybox

\makeatletter
% https://tex.stackexchange.com/a/383700/4686
\newcommand\SetToRatio[3]{% sets #1 to be the ratio #2/#3, where #2 and #3 
    % are lengths (registers or expressions).
    % The ratio #2/#3 should evaluate to less than 16384 in absolute value to 
    % avoid arithmetic overflow. It will be computed as fixed point
    % number with about 4 or 5 digits after decimal mark.
    \edef #1%
    {\strip@pt\dimexpr
        \numexpr\dimexpr#2\relax*65536/\dimexpr#3\relax\relax sp\relax}%
}
\makeatother

%Custom command for inserting cover picture.  Try three different file formats.
\newcommand{\InsertFCCoverPicture}{
    \IfFileExists{./images/cover.png}{\includepdf{./images/cover.png}}{
        \IfFileExists{./images/cover.jpg}{\includepdf{./images/cover.jpg}}{
            \IfFileExists{./images/cover.bmp}{\includepdf{./images/cover.bmp}}{
                %No other options
            }
        }
    }
}

% Custom command for creating title page and table of contents.
\newcommand{\InsertFCTitleAndTOC}[2]{
    {
            \InsertFCCoverPicture{}

            \let\cleardoublepage\clearpage
            \begin{titlepage}
                \thispagestyle{FancyTOC}
                \begin{center}

                    \vspace{0.1\pageheight}

                    {
                        \Kochfont\fontsize{75}{90}\selectfont
                        Flying\\
                        \reflectbox{\resizebox*{3\width}{3\height}{\rotatebox{90}{$\vartheta$}}}
                        \Kochfont\fontsize{75}{90}\selectfont Circus
                        \resizebox*{3\width}{3\height}{\rotatebox{90}{$\vartheta$}}
                    }

                    \normalfont\Huge
                    Aircraft Catalogue\\
                    #1\\
                    \resizebox*{10\width}{3\height}{\rotatebox{90}{$\varsigma$}}
                    \reflectbox{\resizebox*{10\width}{3\height}{\rotatebox{90}{$\varsigma$}}}

                    \vspace*{\fill}

                    #2\\

                    \vspace*{0.05\pageheight}
                \end{center}
            \end{titlepage}
        } %%% and here.


    \begin{center}
        \Huge\Kochfont Contents
    \end{center}

    \vspace{1cm}

    \tableofcontents

    \thispagestyle{fancy}
    \newpage
    \pagenumbering{arabic}
    \setlength{\parindent}{0pt}
}

%%%%% Command for Making a Flying Circus Vehicle %%%%
% This is used for making magenta text to show when keys aren't being set.
\newcommand{\FrameDefault}[1]{\tcbox[colframe=magenta,colback=magenta,nobeforeafter,size=tight]{\textcolor{white}{#1}}}

% The \FrameDefalt shows when things aren't set.
\pgfkeys{
    /FCVehicle/.is family, FCVehicle,
    % Here are the options that a user can pass
    default/.style =
        {Name = \FrameDefault{Flaktraktor-BC ``Flaktor''}, Price = \FrameDefault{25},
            Nickname = \FrameDefault{Buzz Off}, Upkeep = \FrameDefault{1},
            Speed = \FrameDefault{3}, Torque = \FrameDefault{+1}, Handling = \FrameDefault{15},
            Armour = \FrameDefault{2/2/1}, Integrity = \FrameDefault{20}, Safety = \FrameDefault{2},
            Reliability = \FrameDefault{0}, Fuel Uses = \FrameDefault{10}, Stress = \FrameDefault{1},
            Size = \FrameDefault{Large Size}, Cargo = \FrameDefault{Tiny Cargo},
            Crew = {}, Box Text = {}, Box Loc = {north east},
            Facing Image = {NoImageFound}, Text Offset = {0pt}
        },
    Name/.store in = \FCName,
    Name/.value required,
    Price/.store in = \FCPrice,
    Nickname/.store in = \FCNickname,
    Upkeep/.store in = \FCUpkeep,
    Speed/.store in = \FCSpeed,
    Torque/.store in = \FCTorque,
    Handling/.store in = \FCHandling,
    Armour/.store in = \FCArmour,
    Integrity/.store in = \FCIntegrity,
    Safety/.store in = \FCSafety,
    Reliability/.store in = \FCReliability,
    Fuel Uses/.store in = \FCFuelUses,
    Stress/.store in = \FCStress,
    Size/.store in = \FCSize,
    Cargo/.store in = \FCCargo,
    Crew/.store in = \FCCrew,
    Box Text/.store in = \FCBoxText,
    Box Loc/.store in = \FCBoxLoc,
    Facing Image/.store in = \FCFacingImage,
    Text Offset/.store in = \FCTextOffset,
}
% Actual command
\newcommand{\FCVehicle}[2][]{%
    % Always starts on left page
    \cleardoublepage
    % Parse the keys passed in
    \pgfkeys{FCVehicle, default, #1}%
    \phantomsection\label{\FCFacingImage}
    \begin{tikzpicture}[remember picture, overlay]
        \node[anchor=north, inner sep=0pt] (image) at (current page.north) {
            \includegraphics[width=\paperwidth, keepaspectratio]{\FCFacingImage}
        };
        \ifdefempty{\FCBoxText}{}{
            \node[fill=white, fill opacity=0.7, text opacity=1, inner sep=0pt, outer sep=1cm, anchor=\FCBoxLoc] at (image.\FCBoxLoc) {
                \large
                \begin{NiceTabular}{l}[rules/color=[gray]{0.75}, rules/width=1pt, hvlines]
                    \FCBoxText
                \end{NiceTabular}
            };
        }
    \end{tikzpicture}

    \sbox{\mybox}{\includegraphics[draft, width=\paperwidth, keepaspectratio]{\FCFacingImage}}
    \SetToRatio\aspectratio{\dimexpr\ht\mybox+\dp\mybox\relax}{\wd\mybox}
    \setlength{\picvert}{\aspectratio\paperwidth - 1in}
    \setlength{\picvert}{\picvert - \voffset}
    \setlength{\picvert}{\picvert + \FCTextOffset}
    \vspace{\picvert}

    \addcontentsline{toc}{section}{ \FCName }
    \uline{{\huge \textcolor{DarkGray}{\FCName}}\hfill}
    \Large\normalfont\noindent\justify
    \setlength{\parindent}{0pt}
    #2
    \clearpage
    \begin{center}
        \parbox[l]{0.6\textwidth}{\uline{\Huge\FCName\hfill\Large\FCPrice þ} \\ \FCNickname\hfill Upkeep \FCUpkeep þ}
        \begin{NiceTabular}{cccccc}[hvlines, columns-width=0.1\textwidth]
            \Block{1-2}{Speed}          &  & \Block{1-2}{Torque}       &                       & \Block{1-2}{Handling}    & \\
            \Block{1-2}{\FCSpeed}       &  & \Block{1-2}{\FCTorque}    &                       & \Block{1-2}{\FCHandling}   \\
            \Block{1-2}{Armour}         &  & \Block{1-2}{Integrity}    &                       & \Block{1-2}{Safety}      & \\
            \Block{1-2}{\FCArmour}      &  & \Block{1-2}{\FCIntegrity} &                       & \Block{1-2}{\FCSafety}   & \\
            \Block{1-2}{Reliability}    &  & \Block{1-2}{Fuel Uses}    &                       & \Block{1-2}{Stress}      & \\
            \Block{1-2}{\FCReliability} &  & \Block{1-2}{\FCFuelUses}  &                       & \Block{1-2}{\FCStress}   & \\
            \Block{1-3}{\FCSize}        &  &                           & \Block{1-3}{\FCCargo} &                          & \\
        \end{NiceTabular}

        \vspace{0.5cm}

        {\LARGE\Kochfont Crew}

        \begin{NiceTabular}[width=\textwidth]{lcccX}[hvlines, corners]
             & Type & Vis. & Escape & Notes \\
            \FCCrew
        \end{NiceTabular}
        \vspace{0.5cm}
    \end{center}
}

% Define the keys for \FCPlane
% The \FrameDefalt shows when things aren't set.
\pgfkeys{
    % This is a "variable family"  Doesn't matter, just set to your function name.
    /FCPlane/.is family, FCPlane,
    % Here are the keys that a user can pass
    % First set default values.  The ones with \FrameDefault{} get lit up in bright purple when they're left as default
    default/.style =
        {Name = \FrameDefault{Flaktraktor-BC ``Flaktor''}, Price = \FrameDefault{25}, Used=\FrameDefault{12},
            Nickname = \FrameDefault{Buzz Off}, Upkeep = \FrameDefault{1},
            Stats = {Failure & 0 & 0 & 0 & 0 & 0 \\}, Vital Parts = \FrameDefault{Engine?}, Crew = \FrameDefault{Pilot?},
            Propulsion = {}, Aerodynamics = {}, Survivability = {}, Armament = {},
            Image = {Default.png}, Link = {}, Box Loc = {south east}, Box Text = {},
        },
    % Then there's the list of /.store in = 
    % This is how you translate the names in the function call into LaTeX macros
    % You need one for every key you're going to actually use
    Name/.store in = \FCName,
    Price/.store in = \FCPrice,
    Used/.store in = \FCUsed,
    Nickname/.store in = \FCNickname,
    Upkeep/.store in = \FCUpkeep,
    Stats/.store in = \FCStats,
    Vital Parts/.store in = \FCVitalParts,
    Crew/.store in = \FCCrew,
    Propulsion/.store in = \FCPropulsion,
    Aerodynamics/.store in = \FCAerodynamics,
    Survivability/.store in = \FCSurvivability,
    Armament/.store in = \FCArmament,
    Image/.store in = \FCImage,
    Link/.store in = \FCLink,
    Box Loc/.store in = \FCBoxLoc,
    Box Text/.store in = \FCBoxText,
}
% Define a new command named FCPlane, with 2 arguments, the keys, and a a second one
\newcommand{\FCPlane}[2][]{
    \clearpage % Break the page, clear any figures, ect ect.  Basically, go to next page and continue
    \pgfkeys{FCPlane, default, #1}% Load the keys in the FCPlane family, 
    % then the default values, then the values passed in by the first argument

    % Create a picture across the top of the page using \FCImage, 
    % using the min of the width of the text, or 1/3 the page vertically to set the size
    % Also, if the variable \FCBoxText was filled, make a box in the corner \FCBoxLoc with that text inside a table.
    % Can remove the bit about NiceTabular to make it just a box of text.  See FCVehicle for that.
    \begin{center}
        \begin{tikzpicture}[overlay, remember picture]
            \node[anchor=north] (image) at (current page text area.north) {
                \includegraphics[width=\paperwidth, keepaspectratio]{\FCImage}
            };

            \ifdefempty{\FCBoxText}{}{
                \ifdefempty{\UseDefaultBox}{
                    \node[fill=white, fill opacity=0.7, text opacity=1, inner sep=0pt, outer xsep=2cm, outer ysep=0.5cm, anchor=\FCBoxLoc] at (image.\FCBoxLoc) {
                        \large
                        \begin{NiceTabular}{cc}[rules/color=[gray]{0.75}, rules/width=1pt, hvlines]
                            \FCBoxText
                        \end{NiceTabular}};
                }{
                    \node[fill=white, fill opacity=0.7, text opacity=1, inner sep=0pt, outer xsep=2cm, outer ysep=0.5cm,anchor=\FCBoxLoc] at (image.\FCBoxLoc) {
                        \large
                        \begin{NiceTabular}{|ll|}[rules/color=[gray]{0.75}, rules/width=1pt, hlines]
                            \FCBoxText
                        \end{NiceTabular}};
                }
            }
        \end{tikzpicture}
    \end{center}
    \phantomsection
    \sbox{\mybox}{\includegraphics[draft, width=\paperwidth, keepaspectratio]{\FCImage}}
    \SetToRatio\aspectratio{\dimexpr\ht\mybox+\dp\mybox\relax}{\wd\mybox}
    \vspace{\aspectratio\paperwidth}

    % Some spacing, then add a section entry to the table of contents with the value \FCName
    % \phantomsection puts a "break" so it knows to actually go there.  Totally invisible, but 
    % when you click on the page number in the table of contents, this is the spot it goes.
    \par
    \addcontentsline{toc}{section}{ \FCName }
    % Visible text.  This says Underline all of { \FCName (but huge and dark grey) and all available horizontal space and a messy bit of text after it.}
    % So the name is on the left, and the rest of the text is pushed all the way right by hfill, and it's all underlined.  Just replace the messy bit of 
    % text with the price.  FCPlane can have both, either, or neither of new and used prices.
    \uline{{\huge \textcolor{DarkGray}{\FCName}}
        \hfill
        \large \textcolor{MidGray}{\ifdefempty{\FCPrice}{}{\FCPrice þ New\ifdefempty{\FCUsed}{}{,}} \ifdefempty{\FCUsed}{}{\FCUsed þ Used}}}

    \vspace{-0.2\baselineskip}
    % More text right under the line, again with hfill to pus the rest right
    \Large \textcolor{DarkGray}{\textit{``\FCNickname''}} \hfill \large \textcolor{MidGray}{\FCUpkeep þ Upkeep}

    \vspace{-0.2\baselineskip}
    \large
    \begin{NiceTabular}{ccccc}[first-row, first-col, hvlines, rules/width=1pt]
         & Boost & Handling & Climb & Stall & Speed \\
        \FCStats
    \end{NiceTabular}
    \quad
    \begin{NiceTabular}{c}[first-row, hvlines, rules/width=1pt]
        Vital Parts   \\
        \parbox{0.4\textwidth}{
            \centering
            \vspace{.5\baselineskip}
        \FCVitalParts \\
            \FCCrew
            \vspace{.5\baselineskip}
        }
    \end{NiceTabular}
    \par
    \centering
    \begin{NiceTabular}{c}[columns-width=0.9\textwidth,hvlines, rules/width=1pt]
        \FCPropulsion    \\
        \FCAerodynamics  \\
        \FCSurvivability \\
        \parbox{0.9\textwidth}{
            \raggedright
            \vspace{.5\baselineskip}
            \FCArmament
            \vspace{.5\baselineskip}
        }
    \end{NiceTabular}
    \vspace{0.2\baselineskip}
    % If you want two columns of text, do this, otherwise just 
    % \large \justify #2
    \begin{multicols}{2}
        \raggedcolumns
        \large
        \justify
        \setlength{\parindent}{0pt}
        #2
    \end{multicols}

    \vspace*{\fill}

    \begin{center}
        \href{\FCLink}{\centering \Huge \underline{Plane Builder Link}}
    \end{center}
}


% The \FrameDefalt shows when things aren't set.
\pgfkeys{
    /FCShip/.is family, FCShip,
    % Here are the options that a user can pass
    default/.style = {
            Name = \FrameDefault{Flaktraktor-BC ``Flaktor''}, Notes = {How many Crew?},
            Speed = \FrameDefault{2}, Handling = \FrameDefault{-10},
            Hardness = \FrameDefault{7}, Soak = \FrameDefault{0},
            Strengths = \FrameDefault{-}, Weaknesses = \FrameDefault{-},
            Vital Parts = {
                    1/ \hfill,
                    1/Sinking,
                },
            Armament = {},
            Image = {NoImageFound},
        },
    Name/.store in = \FCName,
    Notes/.store in = \FCNotes,
    Speed/.store in = \FCSpeed,
    Handling/.store in = \FCHandling,
    Hardness/.store in = \FCHardness,
    Soak/.store in = \FCSoak,
    Strengths/.store in = \FCStrengths,
    Weaknesses/.store in = \FCWeaknesses,
    Vital Parts/.store in = \FCVitalParts,
    Armament/.store in = \FCArmament,
    Image/.store in = \FCImage,
}
\newcommand{\FCShip}[2][]{
    \clearpage
    \pgfkeys{FCShip, default, #1}%

    \begin{center}
        \begin{tikzpicture}[overlay, remember picture]
            \node[anchor=north] (image) at (current page text area.north) {
                \includegraphics[width=\paperwidth, keepaspectratio]{\FCImage}
            };
        \end{tikzpicture}
    \end{center}
    \phantomsection
    \sbox{\mybox}{\includegraphics[draft, width=\paperwidth, keepaspectratio]{\FCImage}}
    \SetToRatio\aspectratio{\dimexpr\ht\mybox+\dp\mybox\relax}{\wd\mybox}
    \vspace{\aspectratio\paperwidth}
    \par
    \addcontentsline{toc}{section}{ \FCName }
    \begin{Kochfont}
        \Huge \FCName
    \end{Kochfont}

    \Large
    \setlength{\parindent}{0pt}
    #2

    \vfill

    \begin{NiceTabular}{|Wc{0.3\textwidth}|Wc{0.3\textwidth}Wc{0.15\textwidth}}[hlines,rules/width=1pt]
        Speed        & Handling      & \\
        \FCSpeed     & \FCHandling   & \\
        Hardness     & Soak          & \\
        \FCHardness  & \FCSoak       & \\
        Strengths    & Weaknesses    & \\
        \FCStrengths & \FCWeaknesses & \\
        \CodeAfter
        \begin{tikzpicture}[pos=3-3]
            \expanded{\unexpanded{\pie[color=white, hide number, text=inside, sum=auto, rotate=90, change direction]}\expandafter}\expandafter{\FCVitalParts}
        \end{tikzpicture}
    \end{NiceTabular}

    \vspace{1em}

    \ifdefempty{\FCArmament}{}{
        \begin{center}
            \begin{Kochfont}
                \LARGE Weapons
            \end{Kochfont}
        \end{center}
        \vspace{0.5em}
        \begin{NiceTabular}{X[2,l]X[c]X[c]X[c]X[c]X[c]}[rules/width=1pt, hvlines, corners]
             & Fore & Left & Right & Rear & Up \\
            \FCArmament
        \end{NiceTabular}
    }

    \ifdefempty{\FCNotes}{}{
        \begin{center}
            \begin{Kochfont}
                \LARGE Notes
            \end{Kochfont}
        \end{center}

        \FCNotes
    }
}

%%%%% Command for Making a Flying Circus Vehicle %%%%

% The \FrameDefalt shows when things aren't set.
\pgfkeys{
    /FCVehicleOnePage/.is family, FCVehicleOnePage,
    % Here are the options that a user can pass
    default/.style =
        {Name = \FrameDefault{Flaktraktor-BC ``Flaktor''}, Price = \FrameDefault{25},
            Nickname = \FrameDefault{Buzz Off}, Upkeep = \FrameDefault{1},
            Speed = \FrameDefault{3}, Torque = \FrameDefault{+1}, Handling = \FrameDefault{15},
            Armour = \FrameDefault{2/2/1}, Integrity = \FrameDefault{20}, Safety = \FrameDefault{2},
            Reliability = \FrameDefault{0}, Fuel Uses = \FrameDefault{10}, Stress = \FrameDefault{1},
            Size = \FrameDefault{Large Size}, Cargo = \FrameDefault{Tiny Cargo},
            Crew = {}, Box Text = {}, Box Loc = {north east},
            Image = {NoImageFound}
        },
    Name/.store in = \FCName,
    Name/.value required,
    Price/.store in = \FCPrice,
    Nickname/.store in = \FCNickname,
    Upkeep/.store in = \FCUpkeep,
    Speed/.store in = \FCSpeed,
    Torque/.store in = \FCTorque,
    Handling/.store in = \FCHandling,
    Armour/.store in = \FCArmour,
    Integrity/.store in = \FCIntegrity,
    Safety/.store in = \FCSafety,
    Reliability/.store in = \FCReliability,
    Fuel Uses/.store in = \FCFuelUses,
    Stress/.store in = \FCStress,
    Size/.store in = \FCSize,
    Cargo/.store in = \FCCargo,
    Crew/.store in = \FCCrew,
    Box Text/.store in = \FCBoxText,
    Box Loc/.store in = \FCBoxLoc,
    Image/.store in = \FCImage,
}
% Actual command
\newcommand{\FCVehicleOnePage}[2][]{%
    % Always starts on left page
    \clearpage
    % Parse the keys passed in
    \pgfkeys{FCVehicleOnePage, default, #1}%
    \phantomsection\label{\FCImage}
    \begin{tikzpicture}[overlay, remember picture]
        \node[anchor=north] (image) at (current page text area.north) {
            \includegraphics[width=\paperwidth, keepaspectratio]{\FCImage}
        };
    \end{tikzpicture}
    \sbox{\mybox}{\includegraphics[draft, width=\paperwidth, keepaspectratio]{\FCImage}}
    \SetToRatio\aspectratio{\dimexpr\ht\mybox+\dp\mybox\relax}{\wd\mybox}
    \vspace{\aspectratio\paperwidth}
    \addcontentsline{toc}{section}{ \FCName }
    % Visible text.  This says Underline all of { \FCName (but huge and dark grey) and all available horizontal space and a messy bit of text after it.}
    % So the name is on the left, and the rest of the text is pushed all the way right by hfill, and it's all underlined.  Just replace the messy bit of 
    % text with the price.  FCPlane can have both, either, or neither of new and used prices.
    \uline{{\huge \textcolor{DarkGray}{\FCName}}
        \hfill
        \huge \textcolor{MidGray}{\ifdefempty{\FCPrice}{}{\FCPrice þ New\ifdefempty{\FCUpkeep}{}{,}} \ifdefempty{\FCUsed}{}{\FCUpkeep þ Upkeep}}}
    \Large\normalfont\noindent\justify
    \setlength{\parindent}{0pt}
    #2
    \begin{center}
        \begin{NiceTabular}{cccccc}[hvlines, columns-width=0.1\pagewidth]
            {Speed}              & {\FCSpeed}       & {Torque}    & {\FCTorque}           & {Handling} & {\FCHandling} \\
            {Armour}             & {\FCArmour}      & {Integrity} & {\FCIntegrity}        & {Safety}   & {\FCSafety}   \\
            {Reliability}        & {\FCReliability} & {Fuel Uses} & {\FCFuelUses}         & {Stress}   & {\FCStress}   \\
            \Block{1-3}{\FCSize} &                  &             & \Block{1-3}{\FCCargo} &            &               \\
        \end{NiceTabular}

        \begin{NiceTabular}[width=\textwidth]{lcccX}[hvlines, corners]
             & Type & Vis. & Escape & Notes \\
            \FCCrew
        \end{NiceTabular}
    \end{center}
}

\newcommand{\PlaybookRuleL}{
    \begin{center}
        \makebox[\linewidth]{\hspace{-0.041\columnwidth}\rule{1.070\columnwidth}{0.5mm}}
    \end{center}
}
\newcommand{\PlaybookRuleR}{
    \begin{center}
        \makebox[\linewidth]{\hspace{0.065\columnwidth}\rule{1.09\columnwidth}{0.5mm}}
    \end{center}
}

\newcommand{\PlaybookParagraph}[2]{
    \uline{\Large {\Kochfont #1} \hfill\normalsize\textit{#2}}
}

% Define the keys for \FCGroundWeapon
% The \FrameDefalt shows when things aren't set.
\pgfkeys{
    % This is a "variable family"  Doesn't matter, just set to your function name.
    /FCGroundWeapon/.is family, FCGroundWeapon,
    default/.style =
        {
            Name = \FrameDefault{Rifle/Carbine}, Price = {},
            Hits = {}, Damage = {}, AP = {}, Range = {}, Tags = {},
            Image = {}
        },
    % Then there's the list of /.store in = 
    % This is how you translate the names in the function call into LaTeX macros
    % You need one for every key you're going to actually use
    Name/.store in = \FCName,
    Price/.store in = \FCPrice,
    Hits/.store in = \FCHits,
    Damage/.store in = \FCDamage,
    AP/.store in = \FCAP,
    Range/.store in = \FCRange,
    Tags/.store in = \FCTags,
    Image/.store in = \FCImage,
}
% Define a new command named FCGroundWeapon, with 2 arguments, the keys, and a a second one
\newcommand{\FCGroundWeapon}[2][]{
    \pgfkeys{FCGroundWeapon, default, #1}% Load the keys in the FCGroundWeapon family, 
    % then the default values, then the values passed in by the first argument

    % Create a picture across the top of the page using \FCImage, 
    % using the min of the width of the text, or 1/3 the page vertically to set the size
    % Also, if the variable \FCBoxText was filled, make a box in the corner \FCBoxLoc with that text inside a table.
    % Can remove the bit about NiceTabular to make it just a box of text.  See FCVehicle for that.
    \phantomsection
    \ifdefempty{\FCImage}{}{\includegraphics[width=\textwidth, keepaspectratio]{\FCImage}}

    \addcontentsline{toc}{subsection}{ \FCName }
    % Visible text.  This says Underline all of { \FCName (but huge and dark grey) and all available horizontal space and a messy bit of text after it.}
    % So the name is on the left, and the rest of the text is pushed all the way right by hfill, and it's all underlined.  Just replace the messy bit of 
    % text with the price.  FCPlane can have both, either, or neither of new and used prices.
    \uline{{\huge \textcolor{DarkGray}{\FCName}}
        \hfill
        \huge \textcolor{MidGray}{\ifdefempty{\FCPrice}{Scrip}{\FCPrice þ}}}

    \vspace{-0.2\baselineskip}

    \textit{#2}

    \begin{NiceTabular}{XXXXXXXX}[hvlines]
        \Block[fill=black]{1-1}{\textcolor{white}{Hits}} & \Block{1-1}{\FCHits} & \Block[fill=black]{1-1}{\textcolor{white}{Damage}} & \Block{1-1}{\FCDamage} &
        \Block[fill=black]{1-1}{\textcolor{white}{AP}}   & \Block{1-1}{\FCAP}   & \Block[fill=black]{1-1}{\textcolor{white}{Range}}  & \Block{1-1}{\FCRange}    \\
        \Block[l]{1-8}{\FCTags}
    \end{NiceTabular}
}

% Define the keys for \FCPlaneWeapon
% The \FrameDefalt shows when things aren't set.
\pgfkeys{
    % This is a "variable family"  Doesn't matter, just set to your function name.
    /FCPlaneWeapon/.is family, FCPlaneWeapon,
    default/.style =
        {
            Name = \FrameDefault{Rifle/Carbine}, Price = {},
            Hits = {}, Damage = {}, AP = {}, Ammo = {}, Tags = {},
            Image = {}
        },
    % Then there's the list of /.store in = 
    % This is how you translate the names in the function call into LaTeX macros
    % You need one for every key you're going to actually use
    Name/.store in = \FCName,
    Price/.store in = \FCPrice,
    Hits/.store in = \FCHits,
    Damage/.store in = \FCDamage,
    AP/.store in = \FCAP,
    Ammo/.store in = \FCAmmo,
    Tags/.store in = \FCTags,
    Image/.store in = \FCImage,
}
% Define a new command named FCPlaneWeapon, with 2 arguments, the keys, and a a second one
\newcommand{\FCPlaneWeapon}[2][]{
    \pgfkeys{FCPlaneWeapon, default, #1}% Load the keys in the FCPlaneWeapon family, 
    % then the default values, then the values passed in by the first argument

    % Create a picture across the top of the page using \FCImage, 
    % using the min of the width of the text, or 1/3 the page vertically to set the size
    % Also, if the variable \FCBoxText was filled, make a box in the corner \FCBoxLoc with that text inside a table.
    % Can remove the bit about NiceTabular to make it just a box of text.  See FCVehicle for that.
    \phantomsection
    \ifdefempty{\FCImage}{}{\includegraphics[width=\textwidth, keepaspectratio]{\FCImage}}

    \addcontentsline{toc}{subsection}{ \FCName }
    % Visible text.  This says Underline all of { \FCName (but huge and dark grey) and all available horizontal space and a messy bit of text after it.}
    % So the name is on the left, and the rest of the text is pushed all the way right by hfill, and it's all underlined.  Just replace the messy bit of 
    % text with the price.  FCPlane can have both, either, or neither of new and used prices.
    \uline{{\huge \textcolor{DarkGray}{\FCName}}
        \hfill
        \huge \textcolor{MidGray}{\ifdefempty{\FCPrice}{Scrip}{\FCPrice þ}}}

    \vspace{-0.2\baselineskip}

    \textit{#2}

    \begin{NiceTabular}{XXXXXXXX}[hvlines]
        \Block[fill=black]{1-1}{\textcolor{white}{Hits}} & \Block{1-1}{\FCHits} & \Block[fill=black]{1-1}{\textcolor{white}{Damage}} & \Block{1-1}{\FCDamage} &
        \Block[fill=black]{1-1}{\textcolor{white}{AP}}   & \Block{1-1}{\FCAP}   & \Block[fill=black]{1-1}{\textcolor{white}{Ammo}}   & \Block{1-1}{\FCAmmo}     \\
        \Block[l]{1-8}{\FCTags}
    \end{NiceTabular}
}

% Define the keys for \FCPlaybook
% The \FrameDefalt shows when things aren't set.
\pgfkeys{
    % This is a "variable family"  Doesn't matter, just set to your function name.
    /FCPlaybook/.is family, FCPlaybook,
    default/.style =
        {
            Name = \FrameDefault{Worker}, SubHeader={Industrial Town}
        },
    % Then there's the list of /.store in = 
    % This is how you translate the names in the function call into LaTeX macros
    % You need one for every key you're going to actually use
    Name/.store in = \FCName,
    SubHeader/.store in =\FCSubHeader
}
\newcommand{\FCPlaybook}[2][]{
    \pgfkeys{FCPlaybook, default, #1}% Load the keys in the FCPlaybook family, 
    % then the default values, then the values passed in by the first argument

    \newgeometry{margin=0.75in}
    \begin{landscape}
        \pagestyle{PlaybookStyle}
        \renewcommand{\rightmark}{\FCName}
        \phantomsection
        \addcontentsline{toc}{section}{ \FCName }
        \begin{multicols}{2}
            \raggedcolumns
            \noindent
            \colorbox{black}{\parbox{\columnwidth-0.5mm}{\textcolor{white}{\Kochfont\Huge \FCName
                        \large \hfill \FCSubHeader}}}
            \normalsize
            #2
        \end{multicols}
    \end{landscape}
    \restoregeometry
}

\newcommand{\FCMove}[2]{
    \parbox{\columnwidth}{
        {\large \fauxsc{#1}}
        \begin{mdframed}[rightline=false,bottomline=false,linecolor=black,linewidth=1pt]
            #2
        \end{mdframed}
    }
}

\etocsettocstyle{}{}
\etocsetstyle{section}
{}
{}
{\textbf{\huge\etocname\dotfill\etocpage}\par\vspace{2em}}
{}
\etocsetstyle{subsection}
{}
{}
{\textbf{\large\etocname\dotfill\etocpage}\par\vspace{2em}}
{}

\newcommand{\smallk}{
    \resizebox{!}{0.8\height}{K}
}

\directlua
{
    fonts.handlers.otf.addfeature
        {
            name = "shuffle",
            type = "multiple",
            data =
                {
                    ["s"] = {"$"},
                    ["k"] = {"ú"},
                },
        }
}